version: 2.1

workflows:
  build:
    jobs:
      - build_images:
          filters:
            branches:
              ignore:
                - master
      - build:
          filters:
            branches:
              ignore:
                - master

orbs:
  aws-cli: circleci/aws-cli@0.1.13

jobs:
  build:
    docker:
      - image: hashicorp/terraform:full
    environment:
      TF_CLI_ARGS_plan: -input=false -lock=false
      TF_CLI_ARGS_init: -input=false -upgrade=true -reconfigure
    steps:
      - checkout
      - run:
          name: terraform lint
          command: terraform fmt -diff -check -recursive
      - run:
          name: init shared
          command: terraform init shared
      - run:
          name: plan shared
          environment:
            TF_WORKSPACE: development
          command: terraform plan -var-file=shared/terraform.tfvars.json shared
      - run:
          name: init environment
          command: terraform init environment
      - run:
          name: plan environment
          environment:
            TF_WORKSPACE: master
            TF_VAR_OPG_DOCKER_TAG: dummy_value
          command: terraform plan -var-file=environment/terraform.tfvars.json environment
  build_images:
    docker:
      - image: 'circleci/python:2.7'
    environment:
      AWS_REGION: eu-west-1
      AWS_CONFIG_FILE: ~/project/aws_config
    steps:
      - aws-cli/install
      - checkout
      - run:
          name: check identity
          command: aws sts get-caller-identity --profile digideps-ci
