{% extends 'AppBundle:Layouts:application.html.twig' %}

{% trans_default_domain "admin" %}
{% set page = 'editUser' %}

{% block htmlTitle %}{{ (page ~ '.htmlTitle') | trans }}{% endblock %}
{% block pageTitle %}{{ (page ~ '.pageTitle') | trans }}{% endblock %}
{% block supportTitleTop %}{{ (page ~ '.supportTitle') | trans }}{% endblock %}

{% block pageContent %}

    {% set numberOfClients = user.clients | length %}
    {% set firstClient = numberOfClients > 0 ? (user.clients | first) : null %}
    {% set reportsCount = firstClient ? firstClient.totalReportCount : 0 %}

    {{ form_start(form, {attr: {novalidate: 'novalidate' }}) }}


    {{ form_input(form.email,'addUserForm.email') }}
    {{ form_input(form.firstname,'addUserForm.firstname') }}
    {{ form_input(form.lastname,'addUserForm.lastname') }}
    {{ form_input(form.addressPostcode,'addUserForm.addressPostcode', {inputClass: 'govuk-!-width-one-third'}) }}

    {% set deputyRole %}
        {{ form_select(form.roleNameDeputy,'addUserForm.roleNameDeputy') }}
        {{ form_checkbox(form.ndrEnabled, 'addUserForm.ndrEnabled') }}
    {% endset %}

    {% set adminRole %}
        {{ form_select(form.roleNameStaff,'addUserForm.roleNameStaff') }}
    {%  endset %}

    {{ form_checkbox_group(form.roleType, 'addUserForm.roleType', {
        disabled: true,
        items: [
            { conditional: deputyRole },
            { conditional: adminRole },
        ]
    }) }}

    {% if reportsCount > 0 %}
        <p class="text">{{ 'editUserForm.reportsExist' | trans }}</p>
    {% endif %}

    {{ form_submit(form.save, 'editUserForm.submit', {'buttonClass': 'behat-link-save'}) }}

    {% if action is defined %}
        {% if action == 'edit' %}
            {% include 'AppBundle:Components/Link:_link-button.html.twig' with {
            transDomain: 'admin',
            linkId: 'admin_cancel',
            linkButtonLabel: 'cancel.label',
            linkHref: path('admin_homepage')
            } %}
        {% endif %}
    {% endif %}

    {% if numberOfClients > 0 %}
        <h2 class="heading-medium">{{ (page ~ '.clientTable.heading') | trans }}</h2>
        <table class="width-two-thirds">
            <thead>
                <tr>
                    <th>{{ (page ~ '.clientTable.header.client') | trans }}</th>
                    <th class="numeric-small text--right">{{ (page ~ '.clientTable.header.caseNumber') | trans }}</th>
                    <th class="numeric-small text--right">{{ (page ~ '.clientTable.header.reports') | trans }}</th>
                </tr>

            </thead>

            {% for client in user.clients %}
                <tr>
                    <td>{{ client.firstname|title }} {{ client.lastname|title }}</td>
                    <td class="numeric-small">{{ client.caseNumber|upper }}</td>
                    <td class="numeric-small">{{ client.totalReportCount }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}

    {{ form_end(form) }}

    {% if action is defined %}
        {% if action == 'edit' %}
            {# only admin are allowed to delete users (except themselves when logged in) #}
            {% if is_granted('ROLE_ADMIN') and app.user.id != user.id %}
                {% if 'ROLE_LAY_DEPUTY' == user.roleName and clientsCount <= 1 and reportsCount == 0 %}
                    {% include 'AppBundle:Components/Link:_link-button.html.twig' with {
                    transDomain: 'admin',
                    linkButtonLabel: firstClient ? 'Delete User and Client' : 'Delete user',
                    linkClass: 'button-warning push--top',
                    linkHref: path('admin_delete_confirm', { id: id })
                    } %}
                {% else %}
                    <p class="text text-secondary push--top">{{ (page ~ '.deleteDisabled') | trans }}</p>
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}

{% endblock %}
