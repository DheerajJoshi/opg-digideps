{% extends 'AppBundle:Layouts:application.html.twig' %}

{% trans_default_domain "admin-documents" %}
{% set transOptions = {} %}
{% set isNewPage = (filters.status == 'new') %}
{% set baseRoute = 'admin_documents' %}

{% block htmlTitle %}{{ 'page.htmlTitle' | trans }}{% endblock %}
{% block pageTitle %}{{ 'page.pageTitle' | trans }}{% endblock %}
{% block pageTitleClass %}heading-large{% endblock %}

{% block supportTitleBottom %}
    <span class="heading-secondary">{{ 'page.supportTitle' | transchoice(records | length) }}</span>
{% endblock %}

{% block helpline %}{% endblock %}

{% block pageContent %}

    <form action="{{ path(baseRoute, {'status': filters.status}) }}" method="GET" class="search-form push--ends">
        <fieldset>
            <legend class="visuallyhidden">Search</legend>
            <label for="search" class="search-label">Search by client, deputy or case number</label>
            <input type="text" id="search" name="q" value="{{ filters.q }}"
                   class="js-search-focus search-input form-control">
            <input type="hidden" name="status" value="{{ filters.status }}" />
            <input id="search_submit" class="button flush--bottom push-half--right behat-link-search" type="submit" value="Search">
            {% if filters.q %}
                <a href="{{ path(baseRoute, {'status': filters.status}) }}">Clear search</a>
            {% endif %}
        </fieldset>

    </form>

    <div class="tabs push--ends">
        <div class="tabs-nav">
            <ul class="tabs-list" role="tablist">
                <li class="tab-item clients {% if isNewPage %}active{% endif %}" role="presentation">
                    <a href="{{ path(baseRoute, {'status': 'new', 'q': filters.q}) }}" role="tab" tabindex="0" aria-selected="true">
                        <span class="data-item bold-large">{{ counts.new }}</span>
                        <span class="data-item bold-xsmall">{{ 'page.tabs.new.label' | trans }}</span>
                    </a>
                </li>
                <li class="tab-item unstarted {% if not isNewPage %}active{% endif %}" role="presentation">
                    <a href="{{ path(baseRoute, {'status': 'archived', 'q': filters.q}) }}" role="tab" tabindex="0" >
                        <span class="data-item bold-large">{{ counts.archived }}</span>
                        <span class="data-item bold-xsmall">{{ 'page.tabs.archived.label' | trans }}</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    {% if  records | length %}
      <table class="push--bottom">
        <thead>
        <tr>
            <th>Client</th>
            <th>Deputy</th>
            <th>Case number</th>
            <th>Documents</th>
            <th>Date</th>
            <th>
                {% if isNewPage %}
                {% else %}
                    User
                {% endif %}
            </th>
        </tr>
        </thead>
        <tbody>
        {% for reportSubmission in records %}
            {% set report = reportSubmission.report %}
            <tr class="behat-region-report-submission-{{ reportSubmission.id }}">
                <td>
                    {{ report.client.fullname }}
                </td>
                <td>
                    {{ reportSubmission.createdBy.fullname }}
                </td>
                <td>
                    {{ report.client.caseNumber }}
                </td>
                <td>
                    <details class="push--bottom">
                        <summary>
                            <span class="summary">{{ 'page.table.rows.documents' | transchoice(reportSubmission.documents | length) }}</span>
                        </summary>
                        <div class="panel panel-border-narrow">
                            <ul class="list list-group" id="docs">
                                {% for document in reportSubmission.documents %}
                                    <li>{{ document.fileName }}{# | {{ document.createdOn | date(" d F Y") }}#}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </details>
                </td>
                <td>
                    {% set submissionDate = reportSubmission.createdOn %}
                    {% if ("now" | date('Y-m-d') == submissionDate | date('Y-m-d')) %}
                        Today
                    {% else %}
                        {{ submissionDate | date('d/m/Y') }}
                    {% endif %}
                    <br/>
                    {{ submissionDate | date('g:ma') }}
                </td>
                <td class="">
                    {% if isNewPage %}
                        <a href="{{ path('admin_document_archive', {'reportSubmissionId': reportSubmission.id}) }}">Archive</a>
                        <br/>
                        <a href="{{ path('admin_documents_download', {'reportSubmissionId': reportSubmission.id}) }}">Download</a>
                    {% else %}
                        {% if reportSubmission.archivedBy %}
                            {{ reportSubmission.archivedBy.firstname | first }}{{ reportSubmission.archivedBy.lastname | first }}
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
      </table>

        {% include 'AppBundle:Components:paginator.html.twig' with {
            currentOffset: filters.offset,
            recordsPerPage: filters.limit,
            totalRecords: counts[filters.status ?: 'total'],
            routeName: 'admin_documents',
            routeParams: {
            'status': filters.status,
            'q': filters.q
            },
            messages: {
                singlePage: '{0} Showing 0 report submissions|{1} Showing 1 report submission|]1,Inf[ Showing %count% report submissions',
                multiPage: 'Showing %from% &ndash; %to% of %total% report submissions'
            }
        } %}


    {% else %}
        No documents found
    {% endif %}


{% endblock %}
