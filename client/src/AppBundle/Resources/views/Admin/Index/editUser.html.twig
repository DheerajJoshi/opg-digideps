{% extends 'AppBundle:Layouts:application.html.twig' %}

{% trans_default_domain "admin" %}
{% set page = 'editUser' %}

{% set navSection = 'users' %}

{% block htmlTitle %}{{ (page ~ '.htmlTitle') | trans }}{% endblock %}
{% block pageTitle %}{{ (page ~ '.pageTitle') | trans }}{% endblock %}
{% block supportTitleTop %}{{ (page ~ '.supportTitle') | trans }}{% endblock %}

{% block pageContent %}

    {% if 'ROLE_LAY_DEPUTY' == user.roleName %}
        {% set numberOfClients = user.clients | length %}
        {% set firstClient = numberOfClients > 0 ? (user.clients | first) : null %}
        {% set reports = firstClient ? firstClient.reports : [] %}
        {% set reportsCount = reports | length %}
    {% endif %}

    {{ form_start(form, {attr: {novalidate: 'novalidate' }}) }}

    {{ form_input(form.firstname,'addUserForm.firstname') }}
    {{ form_input(form.lastname,'addUserForm.lastname') }}

    {% if form.email is defined %}
        {{ form_input(form.email,'addUserForm.emailEdit') }}
    {% endif %}

    {{ form_input(form.addressPostcode,'addUserForm.addressPostcode', {inputClass: 'govuk-!-width-one-third'}) }}

    {% if 'ROLE_LAY_DEPUTY' == user.roleName %}
        {{ form_checkbox(form.ndrEnabled, 'addUserForm.ndrEnabled') }}
    {% endif %}

    {% if 'ROLE_LAY_DEPUTY' == user.roleName and reportsCount > 0 %}
        <p class="text">{{ 'editUserForm.reportsExist' | trans }}</p>
    {% endif %}

    {{ form_submit(form.save, 'editUserForm.submit', {'buttonClass': 'behat-link-save'}) }}

    {% if action is defined %}
        {% if action == 'edit' %}
            {% include 'AppBundle:Components/Link:_link-button.html.twig' with {
            transDomain: 'admin',
            linkId: 'admin_cancel',
            linkButtonLabel: 'cancel.label',
            linkHref: path('admin_homepage')
            } %}
        {% endif %}
    {% endif %}
    {{ form_end(form) }}

    {% if 'ROLE_LAY_DEPUTY' == user.roleName and numberOfClients > 0 %}
        <h2 class="govuk-heading-m">{{ (page ~ '.clientTable.heading') | trans }}</h2>
        <table class="width-two-thirds">
            <thead>
                <tr>
                    <th>{{ (page ~ '.clientTable.header.client') | trans }}</th>
                    <th class="numeric-small text--right">{{ (page ~ '.clientTable.header.caseNumber') | trans }}</th>
                    <th class="numeric-small text--right">{{ (page ~ '.clientTable.header.reports') | trans }}</th>
                </tr>

            </thead>

            {% for client in user.clients %}
                <tr>
                    <td>{{ client.firstname|title }} {{ client.lastname|title }}</td>
                    <td class="numeric-small">{{ client.caseNumber|upper }}</td>
                    <td class="numeric-small">{{ client.reports | length }}</td>
                </tr>
            {% endfor %}
        </table>
    {% elseif user.organisations is not empty %}
        <table class="push--bottom">
            <thead>
                <tr>
                    <th scope="col">{{ 'organisations' | trans({}, 'common') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for organisation in user.organisations %}
                    <tr>
                        <td>
                            <a class="govuk-link" href="{{ path('admin_organisation_view', { id: organisation.id }) }}">{{ organisation.name }}</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
    {% if action is defined %}
        {% if action == 'edit' %}
            {% if is_granted('delete-user', user) %}
                {% include 'AppBundle:Components/Link:_link-button.html.twig' with {
                    transDomain: 'admin',
                    linkButtonLabel: user.getClients|length > 0 ? 'Delete User and Client' : 'Delete user',
                    linkClass: 'button-warning push--top',
                    linkHref: path('admin_delete_confirm', { id: id })
                } %}
            {% endif %}
        {% endif %}
    {% endif %}

{% endblock %}
